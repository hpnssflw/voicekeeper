# Настройка публикации постов

## Токен бота

Токен используется автоматически из переменной окружения `TELEGRAM_BOT_TOKEN`.

**Важно:** Бот **НЕ может** отправлять сообщения самому себе. Используйте один из вариантов ниже.

## Варианты публикации

### 1. Публикация в канал (рекомендуется)

**Требования:**
- Бот должен быть администратором канала
- Указать ID канала или @username

**Настройка в `.env`:**
```env
TELEGRAM_BOT_TOKEN=8383896351:AAFZHQuTFCVhfpNbLx0i6drM3KtNj_gWF7c
PUBLISH_MODE=channel
TELEGRAM_CHANNEL_ID=@hf_develop
```

Или используйте полный URL (автоматически извлечет username):
```env
TELEGRAM_CHANNEL_LINK=https://t.me/hf_develop
```

Также поддерживаются:
- Числовой ID: `TELEGRAM_CHANNEL_ID=-1001234567890`
- Username: `TELEGRAM_CHANNEL_ID=@hf_develop`
- URL: `TELEGRAM_CHANNEL_LINK=https://t.me/hf_develop`

**Как найти ID канала:**
- Для публичных каналов: используйте `@channel_username`
- Для приватных каналов:
  1. Добавьте бота [@userinfobot](https://t.me/userinfobot) в канал
  2. Бот покажет ID канала (формат: `-1001234567890`)

### 2. Рассылка подписчикам (в разработке)

**Настройка в `.env`:**
```env
PUBLISH_MODE=subscribers
```

**Статус:** Эта функция пока не реализована. Нужно:
- Создать коллекцию `bot_subscribers` в MongoDB
- Реализовать получение списка активных подписчиков
- Добавить батчинг и rate limiting для массовых отправок

## Текущий токен

```
TELEGRAM_BOT_TOKEN=8383896351:AAFZHQuTFCVhfpNbLx0i6drM3KtNj_gWF7c
```

Этот токен используется автоматически для:
- Обработки команд и сообщений (webhook/polling)
- Публикации постов (если не найден bot в БД)

## Как работает публикация

1. Пользователь создает пост со статусом `published` в Mini App
2. Пост сохраняется в MongoDB
3. Автоматически добавляется задача в очередь BullMQ
4. Worker получает задачу:
   - Ищет токен в БД (по `botId`)
   - Если не найден → использует `TELEGRAM_BOT_TOKEN` из env
   - Отправляет пост в канал или подписчикам
5. Успех/ошибка логируется в консоль

## Частые ошибки

**"chat not found" / "CHAT_NOT_FOUND"**
→ Бот не администратор канала или неправильный ID

**"Forbidden" / "bot was blocked"**
→ Бот заблокирован пользователем или нет прав

**"TELEGRAM_CHANNEL_ID not set"**
→ Установите `TELEGRAM_CHANNEL_ID` в `.env` для режима `channel`

