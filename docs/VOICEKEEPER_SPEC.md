# VoiceKeeper: –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-—Å—Ç—Ä–∞—Ç–µ–≥ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ Telegram

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
**–î–∞—Ç–∞:** 17.01.2026  
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞](#1-–æ–±–∑–æ—Ä-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Ä–µ—à–µ–Ω–∏—è)
3. [–ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö](#3-–º–æ–¥–µ–ª—å-–¥–∞–Ω–Ω—ã—Ö)
4. [API —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è](#4-api-—Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è)
5. [AI-–ø–∞–π–ø–ª–∞–π–Ω](#5-ai-–ø–∞–π–ø–ª–∞–π–Ω)
6. [–û—á–µ—Ä–µ–¥–∏ –∏ –≤–æ—Ä–∫–µ—Ä—ã](#6-–æ—á–µ—Ä–µ–¥–∏-–∏-–≤–æ—Ä–∫–µ—Ä—ã)
7. [Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è](#7-frontend-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)
8. [–ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏](#8-–ø–ª–∞–Ω-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
9. [–ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏](#9-–∫—Ä–∏—Ç–µ—Ä–∏–∏-–ø—Ä–∏—ë–º–∫–∏)

---

## 1. –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

### 1.1 –°—É—Ç—å –ø—Ä–æ–¥—É–∫—Ç–∞

**VoiceKeeper** ‚Äî AI-–∞–≥–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤ Telegram-–∫–∞–Ω–∞–ª–æ–≤ (5-100K –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤), –∫–æ—Ç–æ—Ä—ã–π:
- –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –∞–≤—Ç–æ—Ä–∞ (**Digital Voice Fingerprint**)
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ —Ç—Ä–µ–Ω–¥—ã –≤ –Ω–∏—à–µ (**Trend Radar**)
- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç—ã –Ω–∞ —Å—Ç—ã–∫–µ —Ç—Ä–µ–Ω–¥–∞ –∏ –∞–≤—Ç–æ—Ä—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è (**–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è**)

### 1.2 –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è

- –ê–≤—Ç–æ—Ä—ã Telegram-–∫–∞–Ω–∞–ª–æ–≤ —Å 5K-100K –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- –ö–æ–Ω—Ç–µ–Ω—Ç-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–∏ –∏ SMM-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã
- –ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª–∏ —Å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–º –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º

### 1.3 –ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å

| –¢–∞—Ä–∏—Ñ | –¶–µ–Ω–∞/–º–µ—Å | –õ–∏–º–∏—Ç—ã |
|-------|----------|--------|
| **Free** | 0 ‚ÇΩ | 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/–º–µ—Å, –±–∞–∑–æ–≤—ã–π Voice Fingerprint |
| **Pro** | 750 ‚ÇΩ | 50 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π/–º–µ—Å, –ø–æ–ª–Ω—ã–π Voice Fingerprint |
| **Business** | 2500 ‚ÇΩ | –ë–µ–∑–ª–∏–º–∏—Ç, Trend Radar, API –¥–æ—Å—Ç—É–ø |

### 1.4 –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

- Time-to-content: —Å–æ–∫—Ä–∞—â–µ–Ω–∏–µ –Ω–∞ 60%
- Engagement rate: —Ä–æ—Å—Ç –Ω–∞ 15% –∑–∞ –º–µ—Å—è—Ü
- Retention (Pro+): >70% –Ω–∞ 3-–π –º–µ—Å—è—Ü

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

### 2.1 –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Å—Ç–µ–∫

```
packages/
  bot/           # Express + Telegraf + BullMQ workers + REST API
  webapp/        # Next.js 16 Telegram Mini App (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
  admin/         # NEW: Next.js 16 Admin Panel (–¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
infra/
  docker-compose.yml
```

### 2.2 –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ü–æ—Ä—Ç | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|------|------------|
| **webapp** | 3000 | Telegram Mini App –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤ (VoiceKeeper UI) |
| **admin** | 3001 | –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π |
| **bot** | 8080 | Backend API + Telegram webhook |
| **chromium** | 3333 | Browserless –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–æ–≤ |

### 2.3 Admin Panel ‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

–û—Ç–¥–µ–ª—å–Ω–æ–µ Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (`packages/admin`) –¥–ª—è:

- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏** ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ Telegram-–±–æ—Ç–æ–≤, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤
- **API –∫–ª—é—á–∏** ‚Äî Gemini/OpenAI API keys, –≤—ã–±–æ—Ä AI-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
- **–ö–∞–Ω–∞–ª—ã –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞** ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏ –¥–ª—è Trend Radar
- **–ú—É–ª—å—Ç–∏–±–æ—Ç** ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –±–æ—Ç–æ–≤ –≤ –æ–¥–Ω–æ–º –∞–∫–∫–∞—É–Ω—Ç–µ
- **–ü–æ–¥–ø–∏—Å—á–∏–∫–∏** ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —ç–∫—Å–ø–æ—Ä—Ç –∞—É–¥–∏—Ç–æ—Ä–∏–∏
- **–†–∞—Å—Å—ã–ª–∫–∏** ‚Äî –º–∞—Å—Å–æ–≤—ã–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
- **VoiceKeeper** ‚Äî –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ AI-—Ñ—É–Ω–∫—Ü–∏—è–º

**–°—Ç—Ä–∞–Ω–∏—Ü—ã Admin Panel:**
```
/                      # Dashboard ‚Äî —Å–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º –±–æ—Ç–∞–º
/bots                  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏ (–¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω, –∫–∞–Ω–∞–ª)
/posts                 # –í—Å–µ –ø–æ—Å—Ç—ã –≤—Å–µ—Ö –±–æ—Ç–æ–≤
/broadcasts            # –†–∞—Å—Å—ã–ª–∫–∏
/subscribers           # –ü–æ–¥–ø–∏—Å—á–∏–∫–∏
/voicekeeper           # AI-—Å—Ç—Ä–∞—Ç–µ–≥ (dashboard)
/voicekeeper/generate  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤
/voicekeeper/fingerprint # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Voice Fingerprint
/trends                # Trend Radar (premium)
/settings              # –ü—Ä–æ—Ñ–∏–ª—å, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
/settings/api-keys     # API –∫–ª—é—á–∏ (Gemini, OpenAI, Browserless)
```

### 2.4 –†–∞—Å—à–∏—Ä–µ–Ω–∏—è Backend –¥–ª—è VoiceKeeper

```
packages/bot/src/
  ai/                          # NEW: AI –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    providers/
      gemini.provider.ts       # Gemini 1.5 Flash (MVP)
      openai.provider.ts       # GPT-4o (–ø—Ä–æ–¥–∞–∫—à–µ–Ω)
    services/
      voice-fingerprint.ts     # –ê–Ω–∞–ª–∏–∑ –∞–≤—Ç–æ—Ä—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è
      trend-radar.ts           # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
      content-generator.ts     # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    prompts/
      fingerprint.prompt.ts    # –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∏–ª—è
      generation.prompt.ts     # –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      
  models/
    VoiceFingerprint.ts        # NEW: –ü—Ä–æ—Ñ–∏–ª—å —Å—Ç–∏–ª—è –∞–≤—Ç–æ—Ä–∞
    Competitor.ts              # NEW: –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    TrendSnapshot.ts           # NEW: –°–Ω–∏–º–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤
    Generation.ts              # NEW: –ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π
    Subscription.ts            # NEW: –ü–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

  workers/
    fingerprint.worker.ts      # NEW: –ê–Ω–∞–ª–∏–∑ —Å—Ç–∏–ª—è (async)
    trend-scan.worker.ts       # NEW: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    generation.worker.ts       # NEW: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞

  queues/
    fingerprint.queue.ts       # NEW
    trend.queue.ts             # NEW
    generation.queue.ts        # NEW
```

### 2.5 –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (docker-compose.yml)

```yaml
version: '3.9'
services:
  mongodb:
    image: mongo:6.0
    ports: ["27017:27017"]
    volumes: [mongodb_data:/data/db]

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  bot:
    build: ../packages/bot
    ports: ["8080:8080"]
    environment:
      - MONGO_URI=mongodb://mongodb:27017/app
      - REDIS_URL=redis://redis:6379
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - BROWSERLESS_URL=ws://chromium:3000

  webapp:
    build: ../packages/webapp
    ports: ["3000:3000"]
    environment:
      - NEXT_PUBLIC_API_BASE=http://bot:8080

  admin:                         # NEW
    build: ../packages/admin
    ports: ["3001:3001"]
    environment:
      - NEXT_PUBLIC_API_BASE=http://bot:8080

  chromium:                      # NEW - –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–∞–Ω–∞–ª–æ–≤
    image: browserless/chrome:latest
    ports: ["3333:3000"]
    environment:
      - MAX_CONCURRENT_SESSIONS=5
      - TIMEOUT=60000

  nginx:
    image: nginx:alpine
    ports: ["80:80", "443:443"]
```

**–ó–∞—á–µ–º Chromium:** –î–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—É–±–ª–∏—á–Ω—ã—Ö Telegram-–∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ `t.me/s/channel` (Server-side rendering –¥–ª—è Trend Radar).

### 2.4 –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–Ω–æ–≤—ã–µ)

```env
# AI Providers
GEMINI_API_KEY=your-gemini-key
OPENAI_API_KEY=your-openai-key        # –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
AI_PROVIDER=gemini                     # gemini | openai

# Trend Radar
BROWSERLESS_URL=ws://chromium:3000
TREND_SCAN_INTERVAL_HOURS=6

# Subscriptions
STRIPE_SECRET_KEY=sk_...               # –∏–ª–∏ –ÆKassa
STRIPE_WEBHOOK_SECRET=whsec_...
```

---

## 3. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### 3.1 VoiceFingerprint (–ü—Ä–æ—Ñ–∏–ª—å —Å—Ç–∏–ª—è –∞–≤—Ç–æ—Ä–∞)

```typescript
// packages/bot/src/models/VoiceFingerprint.ts
import { model, Schema, Types } from 'mongoose';

const VoiceFingerprintSchema = new Schema({
  // –°–≤—è–∑–∏
  userId: { type: Types.ObjectId, ref: 'users', required: true },
  botId: { type: Types.ObjectId, ref: 'bots' }, // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  
  // –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∞–Ω–∞–ª–∏–∑–∞
  sources: [{
    type: { type: String, enum: ['channel', 'posts', 'manual'] },
    channelUsername: String,  // @channel_name
    postIds: [Types.ObjectId],
    sampleCount: Number,
    analyzedAt: Date,
  }],
  
  // NLP-—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å—Ç–∏–ª—è
  style: {
    // –°—Ç—Ä—É–∫—Ç—É—Ä–∞
    avgParagraphLength: Number,      // —Å—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –∞–±–∑–∞—Ü–∞ (—Å–ª–æ–≤)
    avgSentenceLength: Number,       // —Å—Ä–µ–¥–Ω—è—è –¥–ª–∏–Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
    paragraphsPerPost: Number,       // –∞–±–∑–∞—Ü–µ–≤ –Ω–∞ –ø–æ—Å—Ç
    usesBulletPoints: Boolean,       // –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–∏—Å–∫–∏
    usesEmoji: Boolean,              // –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–º–æ–¥–∑–∏
    emojiDensity: Number,            // —ç–º–æ–¥–∑–∏ –Ω–∞ 100 —Å–ª–æ–≤
    
    // –õ–µ–∫—Å–∏–∫–∞
    vocabularyRichness: Number,      // —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Å–ª–æ–≤–∞—Ä—è (0-1)
    formalityScore: Number,          // —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç—å (0-1)
    sentimentTone: String,           // positive/neutral/negative
    dominantTopics: [String],        // –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã
    
    // –ü–∞—Ç—Ç–µ—Ä–Ω—ã
    openingPatterns: [String],       // —Ç–∏–ø–∏—á–Ω—ã–µ –Ω–∞—á–∞–ª–∞ –ø–æ—Å—Ç–æ–≤
    closingPatterns: [String],       // —Ç–∏–ø–∏—á–Ω—ã–µ –∫–æ–Ω—Ü–æ–≤–∫–∏
    ctaStyle: String,                // —Å—Ç–∏–ª—å call-to-action
    
    // –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    signaturePhrases: [String],      // —Ñ–∏—Ä–º–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã
    forbiddenPhrases: [String],      // –∏–∑–±–µ–≥–∞–µ–º—ã–µ —Å–ª–æ–≤–∞
    preferredHashtags: [String],
  },
  
  // –ü—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ (–¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)
  examplePosts: [{
    text: String,
    engagement: Number,              // 0-100 score
    topics: [String],
  }],
  
  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  version: { type: Number, default: 1 },
  status: { type: String, enum: ['pending', 'analyzing', 'ready', 'failed'], default: 'pending' },
  lastAnalyzedAt: Date,
  confidence: Number,                // 0-100, –Ω–∞—Å–∫–æ–ª—å–∫–æ —É–≤–µ—Ä–µ–Ω –≤ –ø—Ä–æ—Ñ–∏–ª–µ
  
}, { timestamps: true });

VoiceFingerprintSchema.index({ userId: 1 });
VoiceFingerprintSchema.index({ status: 1 });

export const VoiceFingerprintModel = model('voice_fingerprints', VoiceFingerprintSchema);
```

### 3.2 Competitor (–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)

```typescript
// packages/bot/src/models/Competitor.ts
import { model, Schema, Types } from 'mongoose';

const CompetitorSchema = new Schema({
  // –í–ª–∞–¥–µ–ª–µ—Ü
  userId: { type: Types.ObjectId, ref: 'users', required: true },
  
  // –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞
  channelUsername: { type: String, required: true }, // @channel
  channelTitle: String,
  subscriberCount: Number,
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  isActive: { type: Boolean, default: true },
  scanFrequency: { type: String, enum: ['hourly', '6h', 'daily'], default: '6h' },
  
  // –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  lastScanAt: Date,
  lastPostId: String,                // ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  totalPostsAnalyzed: { type: Number, default: 0 },
  avgEngagement: Number,
  
}, { timestamps: true });

CompetitorSchema.index({ userId: 1 });
CompetitorSchema.index({ isActive: 1, lastScanAt: 1 });

export const CompetitorModel = model('competitors', CompetitorSchema);
```

### 3.3 TrendSnapshot (–°–Ω–∏–º–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤)

```typescript
// packages/bot/src/models/TrendSnapshot.ts
import { model, Schema, Types } from 'mongoose';

const TrendSnapshotSchema = new Schema({
  userId: { type: Types.ObjectId, ref: 'users', required: true },
  
  // –ü–µ—Ä–∏–æ–¥ —Å–Ω–∏–º–∫–∞
  periodStart: Date,
  periodEnd: Date,
  
  // –ì–æ—Ä—è—á–∏–µ —Ç–µ–º—ã
  hotTopics: [{
    topic: String,
    score: Number,                   // 0-100, –Ω–∞—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä—è—á–∞—è —Ç–µ–º–∞
    mentionCount: Number,
    avgEngagement: Number,
    examples: [{
      competitorId: Types.ObjectId,
      postPreview: String,
      engagement: Number,
    }],
    trend: String,                   // rising/stable/falling
  }],
  
  // –£–ø—É—â–µ–Ω–Ω—ã–µ —Ç–µ–º—ã (—É –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –µ—Å—Ç—å, —É –∞–≤—Ç–æ—Ä–∞ –Ω–µ—Ç)
  missedTopics: [{
    topic: String,
    competitorCount: Number,         // —Å–∫–æ–ª—å–∫–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –ø–∏—à—É—Ç
    lastMentioned: Date,
    potentialScore: Number,          // –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ç–µ–º—ã
  }],
  
  // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  competitorsAnalyzed: Number,
  postsAnalyzed: Number,
  
}, { timestamps: true });

TrendSnapshotSchema.index({ userId: 1, createdAt: -1 });

export const TrendSnapshotModel = model('trend_snapshots', TrendSnapshotSchema);
```

### 3.4 Generation (–ò—Å—Ç–æ—Ä–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–π)

```typescript
// packages/bot/src/models/Generation.ts
import { model, Schema, Types } from 'mongoose';

const GenerationSchema = new Schema({
  // –°–≤—è–∑–∏
  userId: { type: Types.ObjectId, ref: 'users', required: true },
  botId: { type: Types.ObjectId, ref: 'bots' },
  fingerprintId: { type: Types.ObjectId, ref: 'voice_fingerprints' },
  
  // –í—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  input: {
    topic: String,                   // —Ç–µ–º–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    trendId: String,                 // ID —Ç—Ä–µ–Ω–¥–∞ (–µ—Å–ª–∏ –∏–∑ Trend Radar)
    tone: String,                    // –∂–µ–ª–∞–µ–º—ã–π —Ç–æ–Ω
    length: String,                  // short/medium/long
    includeEmoji: Boolean,
    includeCta: Boolean,
    customInstructions: String,      // –¥–æ–ø. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –æ—Ç –∞–≤—Ç–æ—Ä–∞
  },
  
  // –†–µ–∑—É–ª—å—Ç–∞—Ç
  output: {
    generatedText: String,
    alternativeVersions: [String],   // 2-3 –≤–∞—Ä–∏–∞–Ω—Ç–∞
    suggestedTitle: String,
    suggestedButtons: [{
      text: String,
      action: String,
    }],
    confidenceScore: Number,         // –Ω–∞—Å–∫–æ–ª—å–∫–æ AI —É–≤–µ—Ä–µ–Ω
  },
  
  // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
  status: { type: String, enum: ['pending', 'processing', 'completed', 'failed'], default: 'pending' },
  aiProvider: String,                // gemini/openai
  aiModel: String,                   // gemini-1.5-flash
  tokensUsed: Number,
  processingTimeMs: Number,
  error: String,
  
  // –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
  feedback: {
    rating: Number,                  // 1-5
    wasPublished: Boolean,
    publishedPostId: Types.ObjectId,
    userComment: String,
  },
  
}, { timestamps: true });

GenerationSchema.index({ userId: 1, createdAt: -1 });
GenerationSchema.index({ status: 1 });

export const GenerationModel = model('generations', GenerationSchema);
```

### 3.5 Subscription (–ü–æ–¥–ø–∏—Å–∫–∏)

```typescript
// packages/bot/src/models/Subscription.ts
import { model, Schema, Types } from 'mongoose';

const SubscriptionSchema = new Schema({
  userId: { type: Types.ObjectId, ref: 'users', required: true, unique: true },
  
  // –ü–ª–∞–Ω
  plan: { type: String, enum: ['free', 'pro', 'business'], default: 'free' },
  
  // –ü–ª–∞—Ç–µ–∂–∏
  stripeCustomerId: String,
  stripeSubscriptionId: String,
  
  // –ü–µ—Ä–∏–æ–¥—ã
  currentPeriodStart: Date,
  currentPeriodEnd: Date,
  cancelAtPeriodEnd: Boolean,
  
  // –õ–∏–º–∏—Ç—ã –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
  limits: {
    generationsPerMonth: { type: Number, default: 3 },
    competitorsToTrack: { type: Number, default: 0 },
    trendRadarAccess: { type: Boolean, default: false },
    apiAccess: { type: Boolean, default: false },
  },
  
  usage: {
    generationsThisMonth: { type: Number, default: 0 },
    lastResetAt: Date,
  },
  
  // –ò—Å—Ç–æ—Ä–∏—è
  history: [{
    plan: String,
    startedAt: Date,
    endedAt: Date,
    reason: String,                  // upgrade/downgrade/cancel
  }],
  
}, { timestamps: true });

SubscriptionSchema.index({ userId: 1 }, { unique: true });
SubscriptionSchema.index({ plan: 1 });

export const SubscriptionModel = model('subscriptions', SubscriptionSchema);
```

### 3.6 –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ User

```typescript
// –î–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –º–æ–¥–µ–ª—å users
{
  // ... existing fields ...
  
  // VoiceKeeper extensions
  voiceFingerprintId: { type: Types.ObjectId, ref: 'voice_fingerprints' },
  onboardingCompleted: { type: Boolean, default: false },
  preferences: {
    defaultTone: String,
    defaultLength: String,
    notifyOnTrends: { type: Boolean, default: true },
    language: { type: String, default: 'ru' },
  },
}
```

---

## 4. API —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

### 4.1 Voice Fingerprint API

```
POST   /api/fingerprint/analyze
GET    /api/fingerprint
PUT    /api/fingerprint
DELETE /api/fingerprint
```

#### POST /api/fingerprint/analyze
–ó–∞–ø—É—Å–∫–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ —Å—Ç–∏–ª—è –∞–≤—Ç–æ—Ä–∞.

**Request:**
```json
{
  "sources": [
    { "type": "channel", "channelUsername": "@my_channel" },
    { "type": "posts", "postIds": ["id1", "id2"] }
  ]
}
```

**Response:**
```json
{
  "data": {
    "fingerprintId": "fp_abc123",
    "status": "analyzing",
    "estimatedTimeMinutes": 3
  }
}
```

#### GET /api/fingerprint
–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å —Å—Ç–∏–ª—è.

**Response:**
```json
{
  "data": {
    "id": "fp_abc123",
    "status": "ready",
    "confidence": 85,
    "style": {
      "avgParagraphLength": 45,
      "formalityScore": 0.3,
      "sentimentTone": "positive",
      "dominantTopics": ["–º–∞—Ä–∫–µ—Ç–∏–Ω–≥", "–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"],
      "signaturePhrases": ["–¥—Ä—É–∑—å—è", "–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ"],
      "emojiDensity": 2.5
    },
    "lastAnalyzedAt": "2026-01-17T10:00:00Z"
  }
}
```

### 4.2 Competitor & Trends API (Premium)

```
POST   /api/competitors
GET    /api/competitors
DELETE /api/competitors/:id
GET    /api/trends/latest
GET    /api/trends/history
POST   /api/trends/scan          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
```

#### GET /api/trends/latest
–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–Ω–∏–º–æ–∫ —Ç—Ä–µ–Ω–¥–æ–≤.

**Response:**
```json
{
  "data": {
    "periodStart": "2026-01-10T00:00:00Z",
    "periodEnd": "2026-01-17T00:00:00Z",
    "hotTopics": [
      {
        "topic": "AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å–∞",
        "score": 92,
        "trend": "rising",
        "examples": [
          {
            "postPreview": "5 AI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ...",
            "engagement": 4500
          }
        ]
      }
    ],
    "missedTopics": [
      {
        "topic": "–ª–∏—á–Ω—ã–π –±—Ä–µ–Ω–¥ –≤ 2026",
        "competitorCount": 4,
        "potentialScore": 78
      }
    ]
  }
}
```

### 4.3 Generation API

```
POST   /api/generate
GET    /api/generations
GET    /api/generations/:id
POST   /api/generations/:id/feedback
POST   /api/generations/:id/publish
```

#### POST /api/generate
–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ—Å—Ç.

**Request:**
```json
{
  "topic": "–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ChatGPT –¥–ª—è –Ω–∞–ø–∏—Å–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤",
  "trendId": "trend_abc",        // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
  "tone": "friendly",            // friendly/professional/provocative
  "length": "medium",            // short/medium/long
  "includeEmoji": true,
  "includeCta": true,
  "customInstructions": "–î–æ–±–∞–≤—å –ª–∏—á–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é –≤ –Ω–∞—á–∞–ª–µ"
}
```

**Response:**
```json
{
  "data": {
    "generationId": "gen_xyz789",
    "status": "processing",
    "estimatedTimeSeconds": 15
  }
}
```

#### GET /api/generations/:id

**Response (completed):**
```json
{
  "data": {
    "id": "gen_xyz789",
    "status": "completed",
    "output": {
      "generatedText": "–î—Ä—É–∑—å—è, —Ä–∞—Å—Å–∫–∞–∂—É –∏—Å—Ç–æ—Ä–∏—é...",
      "alternativeVersions": [
        "–í—ã –∫–æ–≥–¥–∞-–Ω–∏–±—É–¥—å –∑–∞–¥—É–º—ã–≤–∞–ª–∏—Å—å...",
        "–°–µ–≥–æ–¥–Ω—è —è –ø—Ä–æ–≤—ë–ª —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç..."
      ],
      "suggestedTitle": "ChatGPT –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞",
      "suggestedButtons": [
        { "text": "–ß–∏—Ç–∞—Ç—å –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ", "action": "url" }
      ],
      "confidenceScore": 88
    },
    "tokensUsed": 1250,
    "processingTimeMs": 4200
  }
}
```

#### POST /api/generations/:id/publish
–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç –∏–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

**Request:**
```json
{
  "versionIndex": 0,             // –∫–∞–∫—É—é –≤–µ—Ä—Å–∏—é –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
  "scheduledAt": "2026-01-18T10:00:00Z",
  "publishTarget": "channel"
}
```

### 4.4 Subscription API

```
GET    /api/subscription
POST   /api/subscription/checkout
POST   /api/subscription/portal
POST   /api/subscription/webhook    # Stripe webhook
```

---

## 5. AI-–ø–∞–π–ø–ª–∞–π–Ω

### 5.1 –ü—Ä–æ–≤–∞–π–¥–µ—Ä Gemini (MVP)

```typescript
// packages/bot/src/ai/providers/gemini.provider.ts
import { GoogleGenerativeAI } from '@google/generative-ai';
import { env } from '../../config/env';

export class GeminiProvider {
  private client: GoogleGenerativeAI;
  private model: any;

  constructor() {
    this.client = new GoogleGenerativeAI(env.GEMINI_API_KEY);
    this.model = this.client.getGenerativeModel({ 
      model: 'gemini-1.5-flash',
      generationConfig: {
        temperature: 0.7,
        topP: 0.9,
        maxOutputTokens: 2048,
      }
    });
  }

  async generate(prompt: string): Promise<{ text: string; tokensUsed: number }> {
    const result = await this.model.generateContent(prompt);
    const response = result.response;
    
    return {
      text: response.text(),
      tokensUsed: response.usageMetadata?.totalTokenCount || 0,
    };
  }

  async analyzeStyle(posts: string[]): Promise<StyleAnalysis> {
    const prompt = buildFingerprintPrompt(posts);
    const result = await this.generate(prompt);
    return parseStyleAnalysis(result.text);
  }
}
```

### 5.2 –°–µ—Ä–≤–∏—Å Voice Fingerprint

```typescript
// packages/bot/src/ai/services/voice-fingerprint.ts
import { GeminiProvider } from '../providers/gemini.provider';
import { FINGERPRINT_PROMPT } from '../prompts/fingerprint.prompt';

export class VoiceFingerprintService {
  private ai = new GeminiProvider();

  async analyzeFromPosts(posts: string[]): Promise<FingerprintResult> {
    // 1. –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤
    const cleanedPosts = posts.map(p => this.cleanPost(p));
    
    // 2. –ë–∞–∑–æ–≤—ã–π NLP-–∞–Ω–∞–ª–∏–∑ (–±–µ–∑ AI)
    const basicMetrics = this.calculateBasicMetrics(cleanedPosts);
    
    // 3. AI-–∞–Ω–∞–ª–∏–∑ –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    const prompt = FINGERPRINT_PROMPT
      .replace('{{POSTS}}', cleanedPosts.join('\n---\n'))
      .replace('{{BASIC_METRICS}}', JSON.stringify(basicMetrics));
    
    const aiResult = await this.ai.generate(prompt);
    const parsed = this.parseAIResponse(aiResult.text);
    
    return {
      ...basicMetrics,
      ...parsed,
      confidence: this.calculateConfidence(cleanedPosts.length, parsed),
    };
  }

  private calculateBasicMetrics(posts: string[]) {
    // –°—á–∏—Ç–∞–µ–º –º–µ—Ç—Ä–∏–∫–∏ –±–µ–∑ AI
    return {
      avgParagraphLength: this.avgParagraphLength(posts),
      avgSentenceLength: this.avgSentenceLength(posts),
      usesBulletPoints: posts.some(p => /^[\-\‚Ä¢\*]\s/m.test(p)),
      usesEmoji: posts.some(p => /[\u{1F300}-\u{1F9FF}]/u.test(p)),
      emojiDensity: this.calculateEmojiDensity(posts),
      vocabularyRichness: this.calculateVocabularyRichness(posts),
    };
  }
}
```

### 5.3 –ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∏–ª—è

```typescript
// packages/bot/src/ai/prompts/fingerprint.prompt.ts
export const FINGERPRINT_PROMPT = `
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ NLP –∏ –∞–Ω–∞–ª–∏–∑—É –∞–≤—Ç–æ—Ä—Å–∫–æ–≥–æ —Å—Ç–∏–ª—è –≤ —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ—Å—Ç—ã –∞–≤—Ç–æ—Ä–∞ –∏ —Å–æ–∑–¥–∞–π Digital Voice Fingerprint ‚Äî 
–¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª—è –ø–∏—Å—å–º–∞.

=== –ü–û–°–¢–´ –ê–í–¢–û–†–ê ===
{{POSTS}}

=== –ë–ê–ó–û–í–´–ï –ú–ï–¢–†–ò–ö–ò (—É–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã) ===
{{BASIC_METRICS}}

=== –ó–ê–î–ê–ù–ò–ï ===
–û–ø—Ä–µ–¥–µ–ª–∏ –∏ –≤–µ—Ä–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:

{
  "formalityScore": 0.0-1.0,        // 0=–æ—á–µ–Ω—å –Ω–µ—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π, 1=—Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π
  "sentimentTone": "positive|neutral|negative|mixed",
  "dominantTopics": ["—Ç–µ–º–∞1", "—Ç–µ–º–∞2", "—Ç–µ–º–∞3"],
  "openingPatterns": ["–ø–∞—Ç—Ç–µ—Ä–Ω1", "–ø–∞—Ç—Ç–µ—Ä–Ω2"],
  "closingPatterns": ["–ø–∞—Ç—Ç–µ—Ä–Ω1", "–ø–∞—Ç—Ç–µ—Ä–Ω2"],
  "ctaStyle": "–º—è–≥–∫–∏–π|–ø—Ä—è–º–æ–π|–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç",
  "signaturePhrases": ["—Ñ—Ä–∞–∑–∞1", "—Ñ—Ä–∞–∑–∞2"],
  "forbiddenPhrases": ["—Å–ª–æ–≤–æ1", "—Å–ª–æ–≤–æ2"],
  "preferredHashtags": ["#—Ç–µ–≥1", "#—Ç–µ–≥2"],
  "writingPersonality": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª–∏—á–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∞ –≤ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è—Ö"
}

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON –±–µ–∑ markdown-–æ–±—ë—Ä—Ç–∫–∏.
`;
```

### 5.4 –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

```typescript
// packages/bot/src/ai/prompts/generation.prompt.ts
export const GENERATION_PROMPT = `
–¢—ã ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ Telegram. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞–ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç
–í –¢–û–ß–ù–û–ú –°–¢–ò–õ–ï –∞–≤—Ç–æ—Ä–∞, —Å–æ—Ö—Ä–∞–Ω—è—è –µ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –≥–æ–ª–æ—Å.

=== –ü–†–û–§–ò–õ–¨ –°–¢–ò–õ–Ø –ê–í–¢–û–†–ê (Digital Voice Fingerprint) ===
{{FINGERPRINT}}

=== –ü–†–ò–ú–ï–†–´ –£–°–ü–ï–®–ù–´–• –ü–û–°–¢–û–í –ê–í–¢–û–†–ê ===
{{EXAMPLES}}

=== –ü–ê–†–ê–ú–ï–¢–†–´ –ì–ï–ù–ï–†–ê–¶–ò–ò ===
–¢–µ–º–∞: {{TOPIC}}
–¢–æ–Ω: {{TONE}}
–î–ª–∏–Ω–∞: {{LENGTH}}
–í–∫–ª—é—á–∏—Ç—å —ç–º–æ–¥–∑–∏: {{INCLUDE_EMOJI}}
–í–∫–ª—é—á–∏—Ç—å CTA: {{INCLUDE_CTA}}
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: {{CUSTOM_INSTRUCTIONS}}

=== –ö–û–ù–¢–ï–ö–°–¢ –¢–†–ï–ù–î–ê (–µ—Å–ª–∏ –µ—Å—Ç—å) ===
{{TREND_CONTEXT}}

=== –ó–ê–î–ê–ù–ò–ï ===
1. –ù–∞–ø–∏—à–∏ –ø–æ—Å—Ç –≤ —Å—Ç–∏–ª–µ –∞–≤—Ç–æ—Ä–∞ –Ω–∞ –∑–∞–¥–∞–Ω–Ω—É—é —Ç–µ–º—É
2. –ò—Å–ø–æ–ª—å–∑—É–π –µ–≥–æ —Ç–∏–ø–∏—á–Ω—ã–µ –æ–±–æ—Ä–æ—Ç—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É
3. –°–æ—Ö—Ä–∞–Ω—è–π —É—Ä–æ–≤–µ–Ω—å —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
4. –ù–ï –ö–û–ü–ò–†–£–ô –ø—Ä–∏–º–µ—Ä—ã, —Å–æ–∑–¥–∞–π –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –∫–æ–Ω—Ç–µ–Ω—Ç

–í–µ—Ä–Ω–∏ JSON:
{
  "mainVersion": "—Ç–µ–∫—Å—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø–æ—Å—Ç–∞",
  "alternativeVersions": ["–≤–µ—Ä—Å–∏—è 2", "–≤–µ—Ä—Å–∏—è 3"],
  "suggestedTitle": "–∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞",
  "explanation": "–ø–æ—á–µ–º—É —ç—Ç–æ—Ç –ø–æ—Å—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∏–ª—é –∞–≤—Ç–æ—Ä–∞"
}
`;
```

### 5.5 –°–µ—Ä–≤–∏—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ Telegram-–∫–∞–Ω–∞–ª–æ–≤

```typescript
// packages/bot/src/ai/services/channel-parser.ts
import puppeteer from 'puppeteer-core';
import { env } from '../../config/env';

export class ChannelParser {
  private browserWSEndpoint: string;

  constructor() {
    this.browserWSEndpoint = env.BROWSERLESS_URL;
  }

  async parseChannel(username: string, limit: number = 50): Promise<ChannelPost[]> {
    const browser = await puppeteer.connect({
      browserWSEndpoint: this.browserWSEndpoint,
    });

    try {
      const page = await browser.newPage();
      
      // –ü—É–±–ª–∏—á–Ω–æ–µ –ø—Ä–µ–≤—å—é –∫–∞–Ω–∞–ª–∞
      await page.goto(`https://t.me/s/${username.replace('@', '')}`, {
        waitUntil: 'networkidle2',
      });

      // –°–∫—Ä–æ–ª–ª–∏–º –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤
      await this.autoScroll(page, limit);

      // –ü–∞—Ä—Å–∏–º –ø–æ—Å—Ç—ã
      const posts = await page.evaluate(() => {
        const messages = document.querySelectorAll('.tgme_widget_message');
        return Array.from(messages).map(msg => {
          const text = msg.querySelector('.tgme_widget_message_text')?.textContent || '';
          const views = msg.querySelector('.tgme_widget_message_views')?.textContent || '0';
          const date = msg.querySelector('.tgme_widget_message_date time')?.getAttribute('datetime');
          
          return {
            text: text.trim(),
            views: this.parseViews(views),
            date,
          };
        });
      });

      return posts.slice(0, limit);
    } finally {
      await browser.close();
    }
  }

  private async autoScroll(page: any, targetPosts: number) {
    // –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–æ–≤
    let previousHeight = 0;
    let scrollAttempts = 0;
    
    while (scrollAttempts < 20) {
      const postsCount = await page.evaluate(() => 
        document.querySelectorAll('.tgme_widget_message').length
      );
      
      if (postsCount >= targetPosts) break;
      
      await page.evaluate('window.scrollTo(0, document.body.scrollHeight)');
      await page.waitForTimeout(1000);
      
      const newHeight = await page.evaluate('document.body.scrollHeight');
      if (newHeight === previousHeight) break;
      
      previousHeight = newHeight;
      scrollAttempts++;
    }
  }
}
```

---

## 6. –û—á–µ—Ä–µ–¥–∏ –∏ –≤–æ—Ä–∫–µ—Ä—ã

### 6.1 –ù–æ–≤—ã–µ –æ—á–µ—Ä–µ–¥–∏

```typescript
// packages/bot/src/queues/index.ts - —Ä–∞—Å—à–∏—Ä–∏—Ç—å
import { Queue } from 'bullmq';
import { redisConnection } from '../infra/redis';

// Existing
export const publishQueue = new Queue('publish', { connection: redisConnection });

// VoiceKeeper queues
export const fingerprintQueue = new Queue('fingerprint', { connection: redisConnection });
export const trendQueue = new Queue('trend-scan', { connection: redisConnection });
export const generationQueue = new Queue('generation', { connection: redisConnection });
```

### 6.2 Fingerprint Worker

```typescript
// packages/bot/src/workers/fingerprint.worker.ts
import { Worker, Job } from 'bullmq';
import { redisConnection } from '../infra/redis';
import { VoiceFingerprintService } from '../ai/services/voice-fingerprint';
import { VoiceFingerprintModel } from '../models/VoiceFingerprint';
import { ChannelParser } from '../ai/services/channel-parser';

interface FingerprintJob {
  fingerprintId: string;
  userId: string;
  sources: Array<{
    type: 'channel' | 'posts';
    channelUsername?: string;
    postIds?: string[];
  }>;
}

export const fingerprintWorker = new Worker<FingerprintJob>(
  'fingerprint',
  async (job: Job<FingerprintJob>) => {
    const { fingerprintId, sources } = job.data;
    
    console.log(`üîç Processing fingerprint job: ${fingerprintId}`);
    
    await VoiceFingerprintModel.findByIdAndUpdate(fingerprintId, { status: 'analyzing' });
    
    try {
      // 1. –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç—ã –ø–æ—Å—Ç–æ–≤
      const posts: string[] = [];
      const channelParser = new ChannelParser();
      
      for (const source of sources) {
        if (source.type === 'channel' && source.channelUsername) {
          const channelPosts = await channelParser.parseChannel(source.channelUsername, 30);
          posts.push(...channelPosts.map(p => p.text).filter(t => t.length > 50));
        }
        // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
      }
      
      if (posts.length < 5) {
        throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–º–∏–Ω–∏–º—É–º 5)');
      }
      
      // 2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç–∏–ª—å
      const fingerprintService = new VoiceFingerprintService();
      const result = await fingerprintService.analyzeFromPosts(posts);
      
      // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      await VoiceFingerprintModel.findByIdAndUpdate(fingerprintId, {
        style: result,
        examplePosts: posts.slice(0, 5).map(text => ({ text, topics: result.dominantTopics })),
        status: 'ready',
        confidence: result.confidence,
        lastAnalyzedAt: new Date(),
      });
      
      console.log(`‚úÖ Fingerprint completed: ${fingerprintId}, confidence: ${result.confidence}`);
      
    } catch (error: any) {
      console.error(`‚ùå Fingerprint failed: ${fingerprintId}`, error.message);
      await VoiceFingerprintModel.findByIdAndUpdate(fingerprintId, { 
        status: 'failed',
        error: error.message,
      });
      throw error;
    }
  },
  { connection: redisConnection, concurrency: 2 }
);
```

### 6.3 Trend Scan Worker

```typescript
// packages/bot/src/workers/trend-scan.worker.ts
import { Worker, Job } from 'bullmq';
import { redisConnection } from '../infra/redis';
import { CompetitorModel } from '../models/Competitor';
import { TrendSnapshotModel } from '../models/TrendSnapshot';
import { ChannelParser } from '../ai/services/channel-parser';
import { GeminiProvider } from '../ai/providers/gemini.provider';

interface TrendScanJob {
  userId: string;
  competitorIds: string[];
}

export const trendScanWorker = new Worker<TrendScanJob>(
  'trend-scan',
  async (job: Job<TrendScanJob>) => {
    const { userId, competitorIds } = job.data;
    
    console.log(`üìä Starting trend scan for user: ${userId}`);
    
    const channelParser = new ChannelParser();
    const ai = new GeminiProvider();
    const allPosts: Array<{ competitor: string; text: string; views: number }> = [];
    
    // 1. –ü–∞—Ä—Å–∏–º –ø–æ—Å—Ç—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
    for (const competitorId of competitorIds) {
      const competitor = await CompetitorModel.findById(competitorId);
      if (!competitor) continue;
      
      try {
        const posts = await channelParser.parseChannel(competitor.channelUsername, 20);
        allPosts.push(...posts.map(p => ({
          competitor: competitor.channelUsername,
          text: p.text,
          views: p.views,
        })));
        
        await CompetitorModel.findByIdAndUpdate(competitorId, {
          lastScanAt: new Date(),
          totalPostsAnalyzed: competitor.totalPostsAnalyzed + posts.length,
        });
      } catch (err) {
        console.warn(`Failed to parse ${competitor.channelUsername}:`, err);
      }
    }
    
    // 2. AI-–∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤
    const trendAnalysis = await ai.generate(
      buildTrendAnalysisPrompt(allPosts)
    );
    
    const trends = parseTrendAnalysis(trendAnalysis.text);
    
    // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–Ω–∏–º–æ–∫
    await TrendSnapshotModel.create({
      userId,
      periodStart: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000),
      periodEnd: new Date(),
      hotTopics: trends.hotTopics,
      missedTopics: trends.missedTopics,
      competitorsAnalyzed: competitorIds.length,
      postsAnalyzed: allPosts.length,
    });
    
    console.log(`‚úÖ Trend scan completed: ${trends.hotTopics.length} hot topics found`);
  },
  { connection: redisConnection, concurrency: 1 }
);
```

### 6.4 Generation Worker

```typescript
// packages/bot/src/workers/generation.worker.ts
import { Worker, Job } from 'bullmq';
import { redisConnection } from '../infra/redis';
import { GenerationModel } from '../models/Generation';
import { VoiceFingerprintModel } from '../models/VoiceFingerprint';
import { ContentGenerator } from '../ai/services/content-generator';

interface GenerationJob {
  generationId: string;
  userId: string;
  fingerprintId: string;
  input: {
    topic: string;
    tone: string;
    length: string;
    includeEmoji: boolean;
    includeCta: boolean;
    customInstructions?: string;
    trendContext?: string;
  };
}

export const generationWorker = new Worker<GenerationJob>(
  'generation',
  async (job: Job<GenerationJob>) => {
    const { generationId, fingerprintId, input } = job.data;
    const startTime = Date.now();
    
    console.log(`‚úçÔ∏è Generating content: ${generationId}`);
    
    await GenerationModel.findByIdAndUpdate(generationId, { status: 'processing' });
    
    try {
      // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å —Å—Ç–∏–ª—è
      const fingerprint = await VoiceFingerprintModel.findById(fingerprintId);
      if (!fingerprint || fingerprint.status !== 'ready') {
        throw new Error('Voice fingerprint not ready');
      }
      
      // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
      const generator = new ContentGenerator();
      const result = await generator.generate({
        fingerprint: fingerprint.style,
        examples: fingerprint.examplePosts,
        ...input,
      });
      
      const processingTimeMs = Date.now() - startTime;
      
      // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      await GenerationModel.findByIdAndUpdate(generationId, {
        status: 'completed',
        output: {
          generatedText: result.mainVersion,
          alternativeVersions: result.alternativeVersions,
          suggestedTitle: result.suggestedTitle,
          confidenceScore: result.confidence,
        },
        tokensUsed: result.tokensUsed,
        processingTimeMs,
      });
      
      console.log(`‚úÖ Generation completed: ${generationId}, ${processingTimeMs}ms`);
      
    } catch (error: any) {
      console.error(`‚ùå Generation failed: ${generationId}`, error.message);
      await GenerationModel.findByIdAndUpdate(generationId, {
        status: 'failed',
        error: error.message,
      });
      throw error;
    }
  },
  { connection: redisConnection, concurrency: 3 }
);
```

### 6.5 –ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–æ–≤

```typescript
// packages/bot/src/workers/index.ts
export * from './publish.worker';
export * from './fingerprint.worker';
export * from './trend-scan.worker';
export * from './generation.worker';

// Graceful shutdown
process.on('SIGTERM', async () => {
  console.log('Shutting down workers...');
  await fingerprintWorker.close();
  await trendScanWorker.close();
  await generationWorker.close();
  process.exit(0);
});
```

---

## 7. Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### 7.1 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Frontend

–ü—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–¥–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**:

| –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ | –ü–æ—Ä—Ç | –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è |
|------------|------|-------------------|
| `packages/webapp` | 3000 | Telegram Mini App (–∞–≤—Ç–æ—Ä—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞) |
| `packages/admin` | 3001 | –í–µ–±-–∞–¥–º–∏–Ω–∫–∞ (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã) |

### 7.2 Admin Panel (packages/admin)

**–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è** —Å —Ç—ë–º–Ω–æ–π —Ç–µ–º–æ–π –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–º UI.

```
packages/admin/
  app/
    page.tsx                   # Dashboard
    bots/page.tsx              # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏
    posts/page.tsx             # –í—Å–µ –ø–æ—Å—Ç—ã
    broadcasts/page.tsx        # –†–∞—Å—Å—ã–ª–∫–∏
    subscribers/page.tsx       # –ü–æ–¥–ø–∏—Å—á–∏–∫–∏
    voicekeeper/
      page.tsx                 # VoiceKeeper Dashboard
      generate/page.tsx        # AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è
      fingerprint/page.tsx     # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∏–ª—è
    trends/page.tsx            # Trend Radar
    settings/
      page.tsx                 # –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      api-keys/page.tsx        # API –∫–ª—é—á–∏
  components/
    ui/                        # –ë–∞–∑–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã (Button, Card, Input...)
    layout/
      sidebar.tsx              # –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
      header.tsx               # –®–∞–ø–∫–∞ —Å –ø–æ–∏—Å–∫–æ–º
      bot-selector.tsx         # –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –±–æ—Ç–æ–≤
```

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Admin Panel:**
- –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –ú—É–ª—å—Ç–∏–±–æ—Ç-—Å–µ–ª–µ–∫—Ç–æ—Ä –≤ —Ö–µ–¥–µ—Ä–µ
- –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API –∫–ª—é—á–∞–º–∏
- VoiceKeeper —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –∏ Trend Radar

### 7.3 Telegram Mini App (packages/webapp)

–£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤–Ω—É—Ç—Ä–∏ Telegram.

```
packages/webapp/app/(mini)/mini/
  page.tsx                     # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞ (—Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
  voicekeeper/
    page.tsx                   # –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
```

### 7.2 –û—Å–Ω–æ–≤–Ω–æ–π –¥–∞—à–±–æ—Ä–¥ VoiceKeeper

```tsx
// packages/webapp/app/(mini)/mini/voicekeeper/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { api } from '@/lib/api';

export default function VoiceKeeperDashboard() {
  const [fingerprint, setFingerprint] = useState<Fingerprint | null>(null);
  const [subscription, setSubscription] = useState<Subscription | null>(null);
  const [recentGenerations, setRecentGenerations] = useState<Generation[]>([]);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    const [fp, sub, gens] = await Promise.all([
      api.get('/api/fingerprint'),
      api.get('/api/subscription'),
      api.get('/api/generations?limit=5'),
    ]);
    setFingerprint(fp.data);
    setSubscription(sub.data);
    setRecentGenerations(gens.data);
  };

  return (
    <div className="space-y-6 p-4">
      {/* Voice Fingerprint Status */}
      <Card className="p-4">
        <h2 className="text-lg font-semibold mb-2">üé≠ –¢–≤–æ–π Digital Voice</h2>
        {fingerprint?.status === 'ready' ? (
          <div className="space-y-2">
            <div className="flex items-center gap-2">
              <span className="text-green-500">‚óè</span>
              <span>–ü—Ä–æ—Ñ–∏–ª—å –≥–æ—Ç–æ–≤ (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {fingerprint.confidence}%)</span>
            </div>
            <p className="text-sm text-gray-600">
              –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å: {fingerprint.style.sentimentTone}, 
              –¢–µ–º—ã: {fingerprint.style.dominantTopics.join(', ')}
            </p>
            <Button variant="outline" size="sm">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</Button>
          </div>
        ) : (
          <div>
            <p className="text-gray-500 mb-2">–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</p>
            <Button href="/mini/voicekeeper/fingerprint">
              –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Voice Fingerprint
            </Button>
          </div>
        )}
      </Card>

      {/* Quick Generate */}
      <Card className="p-4">
        <h2 className="text-lg font-semibold mb-3">‚ú® –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è</h2>
        <QuickGenerateForm 
          disabled={fingerprint?.status !== 'ready'}
          remainingGenerations={subscription?.limits.generationsPerMonth - subscription?.usage.generationsThisMonth}
        />
      </Card>

      {/* Recent Generations */}
      <Card className="p-4">
        <h2 className="text-lg font-semibold mb-3">üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h2>
        <div className="space-y-2">
          {recentGenerations.map(gen => (
            <GenerationPreview key={gen.id} generation={gen} />
          ))}
        </div>
      </Card>

      {/* Trend Radar Teaser (if not premium) */}
      {!subscription?.limits.trendRadarAccess && (
        <Card className="p-4 bg-gradient-to-r from-purple-50 to-blue-50">
          <h2 className="text-lg font-semibold mb-2">üì° Trend Radar</h2>
          <p className="text-sm text-gray-600 mb-3">
            –û—Ç—Å–ª–µ–∂–∏–≤–∞–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –Ω–∞—Ö–æ–¥–∏ –≥–æ—Ä—è—á–∏–µ —Ç–µ–º—ã –≤ —Å–≤–æ–µ–π –Ω–∏—à–µ
          </p>
          <Button href="/mini/voicekeeper/subscription">
            –ü–æ–¥–∫–ª—é—á–∏—Ç—å Pro
          </Button>
        </Card>
      )}
    </div>
  );
}
```

### 7.3 –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

```tsx
// packages/webapp/app/(mini)/mini/voicekeeper/generate/page.tsx
'use client';

import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { api } from '@/lib/api';

const generateSchema = z.object({
  topic: z.string().min(5, '–¢–µ–º–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∞—è').max(200),
  tone: z.enum(['friendly', 'professional', 'provocative']),
  length: z.enum(['short', 'medium', 'long']),
  includeEmoji: z.boolean(),
  includeCta: z.boolean(),
  customInstructions: z.string().max(500).optional(),
});

type GenerateForm = z.infer<typeof generateSchema>;

export default function GeneratePage() {
  const [isGenerating, setIsGenerating] = useState(false);
  const [result, setResult] = useState<GenerationResult | null>(null);

  const form = useForm<GenerateForm>({
    resolver: zodResolver(generateSchema),
    defaultValues: {
      tone: 'friendly',
      length: 'medium',
      includeEmoji: true,
      includeCta: true,
    },
  });

  const onSubmit = async (data: GenerateForm) => {
    setIsGenerating(true);
    try {
      // 1. –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
      const { data: { generationId } } = await api.post('/api/generate', data);
      
      // 2. –ü–æ–ª–ª–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞
      let attempts = 0;
      while (attempts < 30) {
        await new Promise(r => setTimeout(r, 1000));
        const { data: gen } = await api.get(`/api/generations/${generationId}`);
        
        if (gen.status === 'completed') {
          setResult(gen);
          break;
        }
        if (gen.status === 'failed') {
          throw new Error(gen.error);
        }
        attempts++;
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="p-4 space-y-6">
      <h1 className="text-xl font-bold">‚ú® –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</h1>
      
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
        <div>
          <label className="block text-sm font-medium mb-1">–¢–µ–º–∞ –ø–æ—Å—Ç–∞</label>
          <textarea
            {...form.register('topic')}
            placeholder="–û —á—ë–º —Ö–æ—á–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å?"
            className="w-full p-3 border rounded-lg"
            rows={3}
          />
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium mb-1">–¢–æ–Ω</label>
            <select {...form.register('tone')} className="w-full p-2 border rounded">
              <option value="friendly">–î—Ä—É–∂–µ–ª—é–±–Ω—ã–π</option>
              <option value="professional">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π</option>
              <option value="provocative">–ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π</option>
            </select>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">–î–ª–∏–Ω–∞</label>
            <select {...form.register('length')} className="w-full p-2 border rounded">
              <option value="short">–ö–æ—Ä–æ—Ç–∫–∏–π</option>
              <option value="medium">–°—Ä–µ–¥–Ω–∏–π</option>
              <option value="long">–î–ª–∏–Ω–Ω—ã–π</option>
            </select>
          </div>
        </div>

        <div className="flex gap-4">
          <label className="flex items-center gap-2">
            <input type="checkbox" {...form.register('includeEmoji')} />
            <span>–≠–º–æ–¥–∑–∏</span>
          </label>
          <label className="flex items-center gap-2">
            <input type="checkbox" {...form.register('includeCta')} />
            <span>–ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é</span>
          </label>
        </div>

        <div>
          <label className="block text-sm font-medium mb-1">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</label>
          <textarea
            {...form.register('customInstructions')}
            placeholder="–î–æ–±–∞–≤—å –ª–∏—á–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é, —É–ø–æ–º—è–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç..."
            className="w-full p-2 border rounded"
            rows={2}
          />
        </div>

        <button
          type="submit"
          disabled={isGenerating}
          className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium disabled:opacity-50"
        >
          {isGenerating ? '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º...' : '‚ú® –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç'}
        </button>
      </form>

      {result && (
        <GenerationResult 
          result={result}
          onPublish={() => {/* publish logic */}}
        />
      )}
    </div>
  );
}
```

---

## 8. –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### 8.1 –§–∞–∑–∞ 1: Core Infrastructure (1 –Ω–µ–¥–µ–ª—è)

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ |
|---|--------|-----------|--------|
| 1.1 | –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (VoiceFingerprint, Generation, Subscription) | üî¥ High | 4h |
| 1.2 | Gemini Provider + –±–∞–∑–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã | üî¥ High | 6h |
| 1.3 | –û—á–µ—Ä–µ–¥–∏ fingerprint + generation | üî¥ High | 4h |
| 1.4 | API endpoints (fingerprint, generate) | üî¥ High | 6h |
| 1.5 | –ë–∞–∑–æ–≤—ã–π –ø–∞—Ä—Å–µ—Ä –∫–∞–Ω–∞–ª–æ–≤ (–±–µ–∑ Browserless) | üü° Med | 4h |

**Deliverable:** –ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã –≤—Ä—É—á–Ω—É—é ‚Üí –ø–æ–ª—É—á–∏—Ç—å fingerprint ‚Üí —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç

### 8.2 –§–∞–∑–∞ 2: Mini App UI (1 –Ω–µ–¥–µ–ª—è)

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ |
|---|--------|-----------|--------|
| 2.1 | VoiceKeeper –¥–∞—à–±–æ—Ä–¥ | üî¥ High | 4h |
| 2.2 | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Fingerprint | üî¥ High | 6h |
| 2.3 | –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ + —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã | üî¥ High | 6h |
| 2.4 | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ—Å—Ç–∞–º–∏ | üü° Med | 4h |
| 2.5 | UI –ø–æ–¥–ø–∏—Å–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞) | üü° Med | 2h |

**Deliverable:** –ü–æ–ª–Ω—ã–π flow –æ—Ç –∞–Ω–∞–ª–∏–∑–∞ –¥–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Mini App

### 8.3 –§–∞–∑–∞ 3: Trend Radar (1 –Ω–µ–¥–µ–ª—è)

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ |
|---|--------|-----------|--------|
| 3.1 | Browserless setup –≤ docker-compose | üü° Med | 2h |
| 3.2 | –ú–æ–¥–µ–ª–∏ Competitor + TrendSnapshot | üü° Med | 3h |
| 3.3 | Channel Parser (Puppeteer) | üü° Med | 6h |
| 3.4 | Trend Scan Worker | üü° Med | 6h |
| 3.5 | API + UI –¥–ª—è Trend Radar | üü° Med | 6h |
| 3.6 | Cron job –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è | üü¢ Low | 2h |

**Deliverable:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –∏ –≤–∏–¥–µ—Ç—å —Ç—Ä–µ–Ω–¥—ã

### 8.4 –§–∞–∑–∞ 4: Subscriptions & Limits (0.5 –Ω–µ–¥–µ–ª–∏)

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ |
|---|--------|-----------|--------|
| 4.1 | Subscription –º–æ–¥–µ–ª—å + middleware | üü° Med | 4h |
| 4.2 | Stripe/–ÆKassa –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | üü° Med | 6h |
| 4.3 | –õ–∏–º–∏—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–π + paywall UI | üü° Med | 4h |

**Deliverable:** –ú–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

### 8.5 –§–∞–∑–∞ 5: Polish & Launch (0.5 –Ω–µ–¥–µ–ª–∏)

| # | –ó–∞–¥–∞—á–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –û—Ü–µ–Ω–∫–∞ |
|---|--------|-----------|--------|
| 5.1 | Onboarding flow | üü° Med | 4h |
| 5.2 | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram | üü¢ Low | 3h |
| 5.3 | –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è | üü¢ Low | 3h |
| 5.4 | –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ E2E | üî¥ High | 6h |

---

## 9. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

### 9.1 MVP (–§–∞–∑—ã 1-2)

- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å 10+ –ø–æ—Å—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å—Ç–∏–ª—è
- [ ] Voice Fingerprint –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∑–∞ <3 –º–∏–Ω—É—Ç
- [ ] –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∏–ª—é –∞–≤—Ç–æ—Ä–∞ (—Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ)
- [ ] –ú–æ–∂–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª
- [ ] Free tier: 3 –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏/–º–µ—Å—è—Ü —Ä–∞–±–æ—Ç–∞—é—Ç

### 9.2 Full Product (–§–∞–∑—ã 3-5)

- [ ] Trend Radar –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–µ–º—ã –∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
- [ ] –ü–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç (–æ–ø–ª–∞—Ç–∞ ‚Üí –¥–æ—Å—Ç—É–ø)
- [ ] –õ–∏–º–∏—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—é—Ç –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Ç—Ä–µ–Ω–¥–∞—Ö –ø—Ä–∏—Ö–æ–¥—è—Ç –≤ Telegram
- [ ] Onboarding –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç >50% –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å

---

## –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### A. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–¥–æ–±–∞–≤–∏—Ç—å –≤ packages/bot/package.json)

```json
{
  "dependencies": {
    "@google/generative-ai": "^0.21.0",
    "puppeteer-core": "^23.0.0",
    "stripe": "^17.0.0"
  }
}
```

### B. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env.example)

```env
# AI
GEMINI_API_KEY=
AI_PROVIDER=gemini

# Trend Radar
BROWSERLESS_URL=ws://localhost:3333

# Payments
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
```

### C. –ú–∏–≥—Ä–∞—Ü–∏–∏

```javascript
// infra/scripts/migrate-voicekeeper.js
db.users.updateMany({}, { 
  $set: { 
    voiceFingerprintId: null, 
    onboardingCompleted: false 
  } 
});

db.subscriptions.createIndex({ userId: 1 }, { unique: true });
db.voice_fingerprints.createIndex({ userId: 1 });
db.generations.createIndex({ userId: 1, createdAt: -1 });
```

---

**–î–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ VoiceKeeper.**  
–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤–Ω–æ—Å—è—Ç—Å—è —á–µ—Ä–µ–∑ PR —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞.

